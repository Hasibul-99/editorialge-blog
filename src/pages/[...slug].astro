---
import Breadcrumb from "@/components/common/Breadcrumb.astro";
import RTEDrawer from "@/components/RTE-drawer/index.astro";
import SidebarWrap from "@/components/sidebar-wrap/index.astro";
import BlogDetailsSocial from "@/components/social/BlogDetailsSocial.astro";
import PostShare from "@/components/social/PostShare.astro";
import { postDetails, postList } from "@/scripts/graphql-query";
import { getPostSEOMeta, showImage } from "@/scripts/helpets";
import dayjs from "dayjs";
import i18next, { changeLanguage } from "i18next";
import Layout from "../layouts/Layout.astro";

changeLanguage("en");

export const prerender = true;
// Fetch all slugs during build time for static paths
export async function getStaticPaths() {
    const lan = i18next.language;
    const response = await fetch(`${import.meta.env.PUBLIC_BASEURL}/graphql`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            query: postList(lan),
        }),
    });
    const json = await response.json();
    const { posts = [] } = json.data;
    const paths = posts.map((post: any) => ({
        params: { slug: post.slug },
    }));
    return paths;
}
type Props = any;
const { slug } = Astro.params;
const lan = i18next.language;
const data = await fetch(`${import.meta.env.PUBLIC_BASEURL}/graphql`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
        query: postDetails(slug, lan),
    }),
});
const json = await data.json();
// Check if json.data exists, if not the GraphQL query failed
if (!json.data) {
    console.error("GraphQL query failed:", json);
    throw new Error("Failed to fetch post data");
}
const { posts, categories, latestPosts } = json.data;
// Extract the post data correctly - posts is an array from GraphQL
const post = posts?.length ? posts[0] : null;
// If no post found, this is a 404
if (!post) {
    console.error("Post not found for slug:", slug);
    throw new Error("Post not found");
}
const attributes = post; // The post object contains all the attributes directly
// Handle categories and latestPosts data
const hotCategories = categories || [];
const latestPostsData = latestPosts || [];
const imageUrl = showImage(attributes?.image);
---

<Layout pageData={getPostSEOMeta(attributes, slug)}>
  <Breadcrumb data={attributes?.breadcrumb || []} />

  <!-- blog-details-area -->
  <section class="blog-details-area pt-60 pb-60">
    <div class="container">
      <div class="author-inner-wrap">
        <div class="row justify-content-center">
          <div class="col-70">
            <div class="blog-details-wrap">
              <div class="blog-details-content">
                <div class="blog-details-content-top">
                  {
                    attributes?.category ? (
                      <a
                        href={"/category/" + attributes?.category?.slug}
                        class="post-tag"
                      >
                        {attributes?.category?.title}
                      </a>
                    ) : (
                      ""
                    )
                  }
                  <h2 class="title">
                    {attributes.title || ""}
                  </h2>
                  <div class="bd-content-inner">
                    <div class="blog-post-meta">
                      <ul class="list-wrap">
                        {
                          attributes?.createdBy?.firstname ? (
                            <li>
                              <i class="flaticon-user" />
                              by
                              <a href="#">{attributes?.createdBy?.firstname}</a>
                            </li>
                          ) : (
                            ""
                          )
                        }
                        <li>
                          <i class="flaticon-calendar"></i>
                          {dayjs(attributes.createdAt).format("DD MMMM, YYYY")}
                        </li>
                      </ul>
                    </div>

                    <BlogDetailsSocial />
                  </div>
                </div>
                <div class="blog-details-thumb">
                  {
                    imageUrl ? (
                      <img src={imageUrl} alt="" />
                    ) : (
                      <div
                        class="no-image-placeholder"
                        style="height: 300px; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #666;"
                      >
                        No image available
                      </div>
                    )
                  }
                </div>

                <RTEDrawer
                  content={attributes.content_first || ""}
                  showFirst={true}
                />

                <RTEDrawer
                  content={attributes.content_sec || ""}
                  showFirst={true}
                />

                <div class="blog-details-bottom">
                  <div class="row align-items-center">
                    <div class="col-lg-6">
                      {
                        attributes.tags?.length ? (
                          <div class="post-tags">
                            <h5 class="title">Tags:</h5>
                            <ul class="list-wrap">
                              {attributes.tags.map((tag: any, idx: number) => (
                                <li>
                                  <a href="#">{tag.title}</a>
                                </li>
                              ))}
                            </ul>
                          </div>
                        ) : null
                      }
                    </div>
                    <div class="col-lg-6">
                      <PostShare />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-30">
            <SidebarWrap
              categories={hotCategories}
              latestPosts={latestPostsData}
            />
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- blog-details-area-end -->
</Layout>
